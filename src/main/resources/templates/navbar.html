<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>
<div th:fragment="navbar">

    <div class="navbar">
        <div class="nav-left">
            <!-- íŠ¹ì • í˜ì´ì§€ì—ì„œë§Œ ë³´ì´ë„ë¡ JSê°€ display ì œì–´ -->
            <button id="menuBtn" class="menu-btn" type="button"
                    aria-label="ë©”ë‰´ ì—´ê¸°" aria-expanded="false" style="display:none;">â˜°</button>

            <div class="title"><a href="/">MacGyver ì‚¬ì´íŠ¸</a></div>
        </div>

        <div class="nav-buttons" id="nav-user-area"></div>
    </div>

    <!-- Drawer (JSê°€ íŠ¹ì • í˜ì´ì§€ì—ì„œë§Œ í™œì„±í™”) -->
    <div id="drawerOverlay" class="drawer-overlay" hidden></div>

    <aside id="drawer" class="drawer" aria-hidden="true">
        <div class="drawer-header">
            <div class="drawer-title">MENU</div>
            <button id="drawerCloseBtn" class="drawer-close" type="button" aria-label="ë©”ë‰´ ë‹«ê¸°">âœ•</button>
        </div>

        <nav class="drawer-nav">
            <a href="/">ğŸ  í™ˆ</a>
            <a href="/ascii/list">ğŸŒ ì „ì²´ ê°¤ëŸ¬ë¦¬</a>
            <a href="/ascii/my" onclick="return goMyPage(event)">ğŸ™‹ ë‚´ ì‘í’ˆ</a>
            <a id="drawerWithdrawLink" href="/withdraw" class="drawer-danger" style="display:none;">
                ğŸš¨ íšŒì› íƒˆí‡´
            </a>
        </nav>
    </aside>

    <style>
        .navbar {
          width: 100%;
          height: 60px;
          background: #222;
          color: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0 20px;
          box-sizing: border-box;
          position: sticky;
          top: 0;
          z-index: 1000;
        }

        .nav-left{
          display:flex;
          align-items:center;
          gap:10px;
        }

        .navbar .title a {
          color: white;
          text-decoration: none;
          font-size: 22px;
          font-weight: bold;
        }
        .navbar .title a:hover { text-decoration: underline; }

        .nav-buttons {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .nav-buttons a, .nav-buttons button {
          color: white;
          text-decoration: none;
          font-size: 15px;
          padding: 8px 12px;
          border-radius: 5px;
          background: #3a3a3a;
          border: none;
          cursor: pointer;
          white-space: nowrap;
        }
        .nav-buttons a:hover, .nav-buttons button:hover { background: #555; }

        /* í–„ë²„ê±° */
        .menu-btn{
          font-size:20px;
          background:transparent;
          border:none;
          color:white;
          cursor:pointer;
          padding: 6px 8px;
          border-radius: 6px;
        }
        .menu-btn:hover{ background:#333; }

        /* ì˜¤ë²„ë ˆì´ */
        .drawer-overlay{
          position:fixed;
          inset:0;
          background:rgba(0,0,0,0.45);
          z-index:999;
        }

        /* ë“œë¡œì–´ */
        .drawer{
          position:fixed;
          top:0;
          left:0;
          height:100vh;
          width:280px;
          background:#fff;
          box-shadow: 2px 0 10px rgba(0,0,0,0.18);
          transform: translateX(-100%);
          transition: transform .2s ease;
          z-index:1000;
          display:flex;
          flex-direction:column;
        }
        .drawer.open{ transform: translateX(0); }

        .drawer-header{
          display:flex;
          align-items:center;
          justify-content:space-between;
          padding:14px 16px;
          border-bottom:1px solid #eee;
        }
        .drawer-title{ font-weight:700; color:#222; }
        .drawer-close{
          background:transparent;
          border:none;
          font-size:18px;
          cursor:pointer;
        }

        .drawer-nav{
          display:flex;
          flex-direction:column;
          padding:10px 12px;
          gap:8px;
        }
        .drawer-nav a{
          padding:10px 10px;
          border-radius:8px;
          text-decoration:none;
          color:#222;
        }
        .drawer-nav a:hover{ background:#f2f2f2; }

        .no-scroll{ overflow:hidden; }
        .drawer-danger{
            color:#dc3545;
            font-weight:700;
        }
            .drawer-danger:hover{
            background: rgba(220,53,69,0.08);
        }

    </style>

    <script>
        async function setupNavbar() {
          const area = document.getElementById("nav-user-area");
          const withdrawLink = document.getElementById("drawerWithdrawLink");
          const path = window.location.pathname;

          if (path === "/login" || path === "/newbody") {
            area.innerHTML = `<a href="/">í™ˆìœ¼ë¡œ</a>`;
            if (withdrawLink) withdrawLink.style.display = "none";
            return;
          }

          try {
            const res = await fetch("/api/auth/me", { method: "GET", credentials: "include" });
            if (!res.ok) throw new Error();

            const text = await res.text();
            const email = text.replace("í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì: ", "");

            area.innerHTML = `
              <a href="/ascii/my" style="font-weight:bold;">${email}</a>
              <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            `;
            if (withdrawLink) withdrawLink.style.display = "block";
          } catch (e) {
            area.innerHTML = `
              <a href="/login">ë¡œê·¸ì¸</a>
              <a href="/newbody">íšŒì›ê°€ì…</a>
            `;
            if (withdrawLink) withdrawLink.style.display = "none";
          }
        }

        function getCsrfTokenFromCookie() {
          const cookie = document.cookie.split('; ').find(row => row.startsWith('XSRF-TOKEN='));
          return cookie ? cookie.split('=')[1] : null;
        }

        async function logout() {
          const token = getCsrfTokenFromCookie();
          await fetch("/api/auth/logout", {
            method: "POST",
            headers: { "X-XSRF-TOKEN": token },
            credentials: "include"
          });
          location.href = "/";
        }

        //ìŠ¬ë¼ì´ë“œ ë©”ë‰´: /, /ascii/list, /ascii/my ì—ì„œë§Œ ë³´ì´ê²Œ
        function setupDrawer() {
          const path = window.location.pathname;

          const allowed =
            (path === "/") ||
            (path === "/ascii/list") ||
            (path === "/ascii/my");

          const menuBtn = document.getElementById("menuBtn");
          const drawer = document.getElementById("drawer");
          const overlay = document.getElementById("drawerOverlay");
          const closeBtn = document.getElementById("drawerCloseBtn");

          if (!menuBtn || !drawer || !overlay || !closeBtn) return;

          if (!allowed) {
            menuBtn.style.display = "none";
            overlay.hidden = true;
            drawer.classList.remove("open");
            return;
          }

          menuBtn.style.display = "inline-block";

          function openDrawer(){
            drawer.classList.add("open");
            overlay.hidden = false;
            drawer.setAttribute("aria-hidden","false");
            menuBtn.setAttribute("aria-expanded","true");
            document.body.classList.add("no-scroll");
          }

          function closeDrawer(){
            drawer.classList.remove("open");
            overlay.hidden = true;
            drawer.setAttribute("aria-hidden","true");
            menuBtn.setAttribute("aria-expanded","false");
            document.body.classList.remove("no-scroll");
          }

          if (!menuBtn.dataset.bound) {
            menuBtn.addEventListener("click", openDrawer);
            closeBtn.addEventListener("click", closeDrawer);
            overlay.addEventListener("click", closeDrawer);
            document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeDrawer(); });
            menuBtn.dataset.bound = "1";
          }
        }

        window.addEventListener("load", () => {
          setupNavbar();
          setupDrawer();
        });
        async function goMyPage(e) {
  e.preventDefault();

  try {
    const res = await fetch("/api/auth/me", {
      method: "GET",
      credentials: "include"
    });

    if (!res.ok) {
      location.href = "/login";
      return false;
    }

    location.href = "/ascii/my";
    return false;
  } catch (err) {
    location.href = "/login";
    return false;
  }
}
    </script>

</div>
</body>
</html>