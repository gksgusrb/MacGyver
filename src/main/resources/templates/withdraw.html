<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íšŒì› íƒˆí‡´ | MacGyver</title>
    <style>
        body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f5f5f5; }
        .container { max-width: 700px; margin: 20px auto 40px; padding: 0 16px; }
        .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
        input { padding:8px 10px; border:1px solid #ccc; border-radius:6px; width:200px; }
        .btn-secondary { background:#6c757d; color:white; padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
        .btn-danger { background:#dc3545; color:white; padding:8px 14px; border:none; border-radius:6px; cursor:pointer; }
    </style>
</head>
<body>

<div th:replace="~{navbar :: navbar}"></div>

<div class="container">
    <h1>íšŒì› íƒˆí‡´</h1>
    <div class="card">
        <p style="color:#666; margin:0 0 10px;">
            íƒˆí‡´ ì‹œ ì‘ì„±í•œ ì‘í’ˆì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. (ì •ì±…)<br>
            ì¸ì¦ë²ˆí˜¸ëŠ” 5ë¶„ ìœ íš¨ì…ë‹ˆë‹¤.
        </p>

        <div class="row">
            <button type="button" class="btn-secondary" onclick="sendWithdrawCode()">ğŸ“¨ íƒˆí‡´ ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</button>
            <input id="withdrawCode" placeholder="6ìë¦¬ ì¸ì¦ë²ˆí˜¸">
            <button type="button" class="btn-danger" onclick="withdraw()">ğŸš¨ íšŒì› íƒˆí‡´</button>
        </div>
    </div>
</div>

<script>
    let csrfHeaderName = "X-XSRF-TOKEN";
    let csrfToken = null;

    async function ensureCsrf() {
      if (csrfToken) return;

      // ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” ë„ˆ SecurityConfigì—ì„œ permitAll í•´ë‘ 
      const res = await fetch("/api/auth/csrf-token", {
        method: "GET",
        credentials: "include"
      });

      if (!res.ok) {
        throw new Error("CSRF í† í° ë°œê¸‰ ì‹¤íŒ¨");
      }

      const data = await res.json(); // { headerName, token }
      csrfHeaderName = data.headerName;
      csrfToken = data.token;
    }

    async function sendWithdrawCode() {
      if (!confirm("íšŒì› íƒˆí‡´ ì¸ì¦ë²ˆí˜¸ë¥¼ ì´ë©”ì¼ë¡œ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      try {
        await ensureCsrf();

        const res = await fetch("/api/auth/withdraw/send-code", {
          method: "POST",
          headers: { [csrfHeaderName]: csrfToken },
          credentials: "include"
        });

        if (res.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          location.href = "/login";
          return;
        }

        const text = await res.text();
        alert(text || (res.ok ? "íƒˆí‡´ ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤." : "íƒˆí‡´ ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ì‹¤íŒ¨"));
      } catch (e) {
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function withdraw() {
      const code = document.getElementById("withdrawCode").value.trim();
      if (!code) return alert("íƒˆí‡´ ì¸ì¦ë²ˆí˜¸(6ìë¦¬)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      if (!confirm("ì •ë§ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níƒˆí‡´í•˜ë©´ ì‘ì„±í•œ ì‘í’ˆì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.")) return;

      try {
        await ensureCsrf();

        const res = await fetch(`/api/auth/withdraw?code=${encodeURIComponent(code)}`, {
          method: "POST",
          headers: { [csrfHeaderName]: csrfToken },
          credentials: "include"
        });

        if (res.status === 401) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          location.href = "/login";
          return;
        }

        const text = await res.text();
        if (res.ok) {
          alert(text || "íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.href = "/";
        } else {
          alert(text || "íšŒì› íƒˆí‡´ ì‹¤íŒ¨");
        }
      } catch (e) {
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }
</script>

</body>
</html>